{{- if .Values.persistence }}
kind: PersistentVolume
apiVersion: v1
metadata:
  name: {{ template "mysql.fullname" . }}-pv
  labels:
    app: {{ template "mysql.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
spec:
  storageClassName: {{ .Values.persistence.storageClass }}
  accessModes:
    {{- range .Values.persistence.accessMode }}
        - {{ . }}
    {{end}}        
  capacity:
      storage: {{ .Values.persistence.size }}
{{- if .Values.persistence.local }}      
  hostPath:
    path: {{ .Values.persistence.hostPath | required "Local path is required" | quote }}
{{end}}    
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
{{- if .Values.affinityNodes -}}                                    
              {{- range .Values.affinityNodes }}
                  - {{ . }}
              {{- end }}
{{else}}
                  - {{ default "minikube" }}              
{{end}}                                   
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: {{ template "mysql.fullname" . }}-claim
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ template "mysql.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
spec:
  accessModes:
    {{- range .Values.persistence.accessMode }}
        - {{ . }}
    {{end}}  
  resources:
    requests:
      storage: {{ .Values.persistence.size }}
  storageClassName: {{ .Values.persistence.storageClass }} 
{{end}}                